# CAN 메세지와 시그널

Created by: Lee Hee Beom
Last edited: May 29, 2025 2:48 PM
Tags: CAN 통신

[1_강의교재_CAN통신_2메세지와시그널_배포_워터마크.pdf](CAN%20%EB%A9%94%EC%84%B8%EC%A7%80%EC%99%80%20%EC%8B%9C%EA%B7%B8%EB%84%90/1_%EA%B0%95%EC%9D%98%EA%B5%90%EC%9E%AC_CAN%ED%86%B5%EC%8B%A0_2%EB%A9%94%EC%84%B8%EC%A7%80%EC%99%80%EC%8B%9C%EA%B7%B8%EB%84%90_%EB%B0%B0%ED%8F%AC_%EC%9B%8C%ED%84%B0%EB%A7%88%ED%81%AC.pdf)

---

### 1. 메시지 ID

- CAN에서 모든 메시지 전송은 **브로드캐스트(Broadcast)** 방식, 즉, 한 제어기에서 **메시지**를 보내면 그 메시지는 네트워크에 연결된 모든 제어기로 전송됨
- 브로드캐스트 방식에서 메시지를 **보내는 제어기**와 **받는 제어기**의 정보가 포함되지 않기 때문에, 수신 제어기는 메시지를 보낸 제어기를 알 수 없음 → 이를 구분하기 위해 **메시지 ID** 사용
- **메시지 ID**는 각 메시지를 식별할 수 있도록 **고유**하게 부여되는 값으로, CAN 네트워크에서 메시지를 보낼 때 사용됨

![image.png](CAN%20%EB%A9%94%EC%84%B8%EC%A7%80%EC%99%80%20%EC%8B%9C%EA%B7%B8%EB%84%90/image.png)

### 2. **CAN 데이터베이스 (CAN DB)**

- 각 메시지의 ID와 이에 대응하는 메시지 이름, 보내는 제어기, 받는 제어기 정보 등은 **CAN 데이터베이스**(또는 **Communication Matrix**)로 관리
- 하나의 제어기에서 다양한 메시지 ID를 보내기도 하지만, 특정한 ID의 메세지는 **그 네트워크 안에서** **하나**의 제어기만 송신해야 함
- 하나의 자동차 안에는 여러 CAN 네트워크가 존재할 수 있으며, 각 네트워크에는 서로 다른 **CAN 데이터베이스**가 존재할 수 있음 (`0x123` ID가 BMS의 메시지로 정의되지만, 다른 네트워크에서는 같은 ID가 다른 메시지를 나타낼 수도 있음)
- 이는 기술적인 제약이 아니라 **약속**으로 엔진 제어기가 소프트웨어 구현에 따라 `0x123` ID를 사용하여 메시지를 보낼 수도 있지만 충돌을 피하기 위해서는 각 제어기 간의 약속을 잘 지켜야 함
- CAN 메시지의 ID는 길이에 따라 두 가지 포맷으로 구분됨 
(하나의 네트워크에서 두 가지 포맷 혼용 가능)
    - **Standard Format** : 11비트
    - **Extended Format** : 29비트

![BMS 제어기는 `0x123` ID의 메시지를 보내고, 엔진 제어기는 `0x500` ID의 메시지를 보내는 식으로, 각 제어기마다 고유한 ID를 부여하여 다른 제어기들이 이를 식별할 수 있음. 수신 제어기는 컨셉상 명시 (브로드캐스트로 모든 제어기에서 수신)](CAN%20%EB%A9%94%EC%84%B8%EC%A7%80%EC%99%80%20%EC%8B%9C%EA%B7%B8%EB%84%90/image%201.png)

BMS 제어기는 `0x123` ID의 메시지를 보내고, 엔진 제어기는 `0x500` ID의 메시지를 보내는 식으로, 각 제어기마다 고유한 ID를 부여하여 다른 제어기들이 이를 식별할 수 있음. 수신 제어기는 컨셉상 명시 (브로드캐스트로 모든 제어기에서 수신)

### 3. 메시지 우선 순위

- CAN 통신은 브로드캐스트 방식으로, 모든 메시지가 네트워크 전체에 전달됨
- 여러 제어기들이 **동시에** 메시지를 보낼 경우, 신호가 겹쳐 통신에 문제가 생길 수 있으며 이를 해결하기 위해 CAN에서는 **한 번에 하나의 메시지**만 보낼 수 있도록 **메시지 ID(Arbitration** 필드)를 통해 **우선순위를 설정**함  → **ID 값이 작을수록 우선순위가 높음 (123>134>154>201)**
    - 우선순위가 높은 메시지가 먼저 보내지고, 우선순위가 낮은 메시지는 대기 → **Arbitration** (중재)
    - CAN에서는 0 (Dominant)이 더 우선순위가 높고, 1 (Recessive)은 상대적으로 우선순위가 낮음
        
        ![image.png](CAN%20%EB%A9%94%EC%84%B8%EC%A7%80%EC%99%80%20%EC%8B%9C%EA%B7%B8%EB%84%90/image%202.png)
        
        ![CAN Controller는 자기가 신호를 보낸 후 Bus에 있는 신호를 읽어 실제로  보낸 신호가 인가 되었는지 확인. 이때 1(Recessive)을 보냈는데 Bus에 0(Dominent) 이 있다는 것을 인지하면 송신 대기
        0(Dominent)가 보내지면 1(Recessive) 가 덮어쓰기 되는 느낌? (0의 우선순위가 더 높음)](CAN%20%EB%A9%94%EC%84%B8%EC%A7%80%EC%99%80%20%EC%8B%9C%EA%B7%B8%EB%84%90/image%203.png)
        
        CAN Controller는 자기가 신호를 보낸 후 Bus에 있는 신호를 읽어 실제로  보낸 신호가 인가 되었는지 확인. 이때 1(Recessive)을 보냈는데 Bus에 0(Dominent) 이 있다는 것을 인지하면 송신 대기
        0(Dominent)가 보내지면 1(Recessive) 가 덮어쓰기 되는 느낌? (0의 우선순위가 더 높음)
        

### 4. **버스 로드 (Bus Load)**

- 전체 네트워크에서 **메시지가 실제로 전달되는 시간의 비율**을 나타내며,  **퍼센트(%)**로 표현 (**CANoe**로 측정 가능)
- 높은 버스 로드는 네트워크에서 더 많은 메시지가 보내지고 있다는 뜻이며, 이 경우 다른 제어기가 메시지를 보내지 못하거나 지연되는 현상이 발생할 수 있음
- 버스 로드를 효율적으로 관리하려면 **메시지 크기(작게)**나 **전송 주기(낮춰)**를 조절해야 함 
(OEM에서 정해줌)

### 5. 시그널

- **메시지**: CAN 통신에서는 **데이터를 주고 받는 단위**로 고유한 아이디(ID)가 있음
- **시그널**: **메시지 안에 포함된** **실제 정보를 나타내는 단위**

       → 배터리 상태 메시지(ID: 0x123)에 배터리 전압(5V), 용량(300W), 허용 전류(10A) 시그널 존재

- CAN 메시지는 **최대 8바이트의 데이터**를 담을 수 있으며, **Data영역**에 시그널의 정보가 담김
- **DLC(Data Length Code)**는 데이터의 길이를 나타내며, 메시지 안에서 실제로 데이터를 몇 바이트를 보낼 것인지 표시, **Control영역**에 정보 담김 → 데이터가 8바이트이면 DLC 값은 4로 설정 
(DL0 DL1 DL2 DL3  = 0 1 0 0)

![CAN 메세지를 나타내는 영역 중 Arbitration Field(11) Control(4) CRC(15) 의 숫자 단위는 각각 bit 며 Data(8)의 8의 단위만 byte ](CAN%20%EB%A9%94%EC%84%B8%EC%A7%80%EC%99%80%20%EC%8B%9C%EA%B7%B8%EB%84%90/image%204.png)

CAN 메세지를 나타내는 영역 중 Arbitration Field(11) Control(4) CRC(15) 의 숫자 단위는 각각 bit 며 Data(8)의 8의 단위만 byte 

- 메시지마다 **어떤 시그널**이 들어 있는지, 시그널의 **위치** 및 **길이**는 **CAN DB**에 저장됨
- 이 정보는 **CAN DB**에 **Start bit**와 **Length** 형태로 기록
- 예를 들어, 4바이트 (배터리 상태 메시지) **데이터 안에서 각 시그널이 차지하는 비트 범위**는 다음과 같이 정의됨  **(1byte = 8bit)**
    - 배터리 전압: 0부터 6비트까지 (7비트 길이) → Start bit = 0, Length = 7
    - 배터리 전류: 7부터 13비트까지 (7비트 길이)ㅡ
    - 배터리 용량: 14부터 27비트까지 (14비트 길이)
        
        ![CANdb에 데이터길이(DLC), Start bit, Length, Unit, Signal Comment, Factor, Offset 등 다양한 정보 포함](CAN%20%EB%A9%94%EC%84%B8%EC%A7%80%EC%99%80%20%EC%8B%9C%EA%B7%B8%EB%84%90/image%205.png)
        
        CANdb에 데이터길이(DLC), Start bit, Length, Unit, Signal Comment, Factor, Offset 등 다양한 정보 포함
        

### 6. Factor 와 Offset

- **실수형 데이터**를 CAN으로 전송할 때, **부동소수점 형태 (Float Type = 4byte)** 그대로 보내면 데이터 크기가 커짐 **(CAN 최대 데이터 = 8byte)**, Bus Load 관리를 위해 데이터의 크기를 줄이는 것이 중요 → 이를 줄이기 위한 방법으로 **Factor**와 **Offset** 활용
- Factor는 **데이터의 정밀도**(소수 몇 째 자리까지 표현), Offset은 **음수**를 표현할 때와 관련 있음
- 예시로, 배터리 전압을 12.4V (실수형) 보내고 싶을 때:
    1. Factor : 0.1 , Offset : 0
    2. 12.4에서 Offset을 빼고, Factor로 나누면 124
    3. 124는 실제로 전송되는 값이며, 받는 쪽에서는 이 값에 다시 Factor(0.1)를 곱하고,  Offset(0)을 더하면 원래 값인 12.4V가 복원
    → **4바이트** 대신 7비트(정수)로 실수형 데이터를 표현할 수 있는 장점
- 하지만, 표현할 수 있는 **값의 범위가 제한** 되므로 Application에 따라 적절한 Factor, Offset 설정 필요 (Float Type의 경우 데이터의 크기는 크지만 표현 범위가 넓음)
    
    ![image.png](CAN%20%EB%A9%94%EC%84%B8%EC%A7%80%EC%99%80%20%EC%8B%9C%EA%B7%B8%EB%84%90/image%206.png)
    
    ![image.png](CAN%20%EB%A9%94%EC%84%B8%EC%A7%80%EC%99%80%20%EC%8B%9C%EA%B7%B8%EB%84%90/image%207.png)
    
    ![image.png](CAN%20%EB%A9%94%EC%84%B8%EC%A7%80%EC%99%80%20%EC%8B%9C%EA%B7%B8%EB%84%90/image%208.png)
    

---